<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>BuildingMap</title>
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
		integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
		crossorigin="" />
	<script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
		integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
		crossorigin=""></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<style>
		#BuildingsMap {
			height: 800px;
		}
	</style>
</head>

<body>
	<p>
		<div id="BuildingsMap" />
	</p>
	<script>
		var buildingsMap = L.map('BuildingsMap');
		var baseMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
		})
		
		$.ajaxSetup({
			scriptCharset: "utf-8",
			contentType: "application/json; charset=utf-8"
		});

		var districtCenter = function (arr) {
			var arrToUse;
			if (arr.length == 1) {
				arrToUse = arr[0];
			} else {
				arrToUse = arr;
			}
			var center = arrToUse.reduce(function (x, y) {
				return [x[0] + y[0] / arrToUse.length, x[1] + y[1] / arrToUse.length]
			}, [0, 0])
			return [center[1], center[0]];
		};

		var colors = ["green", "red", "brown", "orange", "hotpink", "blue"]
		var years = [2014, 2015, 2016, 2017, 2018, 2019]

		var createGeoJsonLayer = function (data, colorName) {
			var style = {
				weight: 2,
				color: colorName,
				fillOpacity: 0.5
			}
			return L.geoJson(data, style);
		};
		var handleGeoJsonLayers = function (dataList) {
			var overlayMaps = {};
			for (var j = 0; j < dataList.length; j++) {
				var entry = dataList[j]
				var color = colors[years.indexOf(entry.year)];
				overlayMaps["<span style='color: " + color + "'>Buildings " + entry.year + "</span>"] = entry.geoJsonLayer;
			}
			var webatlasOptions = {
				layers: 'Siedlung,Vegetation,Gewaesser,Verkehr,Adminstrative_Einheiten,Beschriftung'
			};
			var webatlasLayer = L.tileLayer.wms('https://geodienste.sachsen.de/wms_geosn_webatlas-sn/guest', webatlasOptions);
			var rohdopOptions = {
				layers: 'sn_rohdop_020'
			};
			var rohdopLayer = L.tileLayer.wms('https://geodienste.sachsen.de/wms_geosn_rohdop-rgb/guest', rohdopOptions);
			var rohdopOptions2014 = {
				layers: 'dop_2012_2014_rgb'
			};
			var rohdopLayer2014 = L.tileLayer.wms('https://geodienste.sachsen.de/wms_geosn_dop_2012_2014/guest', rohdopOptions2014);
			var baseMaps = {
				"OSM": baseMap,
				"geodienste.sachsen.de webatlas WMS": webatlasLayer,
				"geodienste.sachsen.de rohdop WMS 2012 - 2014": rohdopLayer2014,
				"geodienste.sachsen.de rohdop WMS 2018": rohdopLayer
			};
			L.control.layers(baseMaps, overlayMaps).addTo(buildingsMap);
			rohdopLayer2014.addTo(buildingsMap);
			years.forEach(year => overlayMaps[year].addTo(buildingsMap));
		};

		var showDistrictBorderLayer = function(data) {
			var style = {
				weight: 2,
				color: 'blue',
				fillOpacity: 0.0
			}
			var geoJsonLayer = L.geoJson(data, style);
			buildingsMap.addLayer(geoJsonLayer);
			geoJsonLayer.eachLayer(function (layer) {
				var coords = layer.feature.geometry.coordinates[0];
				var centroid = districtCenter(coords);
				var zoomLevel = 16;
				buildingsMap.setView(centroid, zoomLevel);
			});
		}

		var showBuildingLayers = function () {
			var promises = []
			for (var i = 0; i < years.length; i++) {
				var year = years[i]
				var path = `geojsons/buildings/Neustadt-Neuschoenefeld-${year}-buildings.geojson`;
				var promise = Promise.all([$.getJSON(path), Promise.resolve(colors[i]), Promise.resolve(year)])
				promises.push(promise.then(data => { 
					return { 
						geoJsonLayer: createGeoJsonLayer(data[0], data[1]), 
						year: data[2]
					} 
				}));
			}
			Promise.all(promises).then(dataList => handleGeoJsonLayers(dataList));
		};

		var showLayers = function (data) {
			showDistrictBorderLayer(data);
			showBuildingLayers();
		};
		$.getJSON("geojsons/districts/Neustadt-Neuschoenefeld.geojson", data => showLayers(data));
	</script>
</body>

</html>
